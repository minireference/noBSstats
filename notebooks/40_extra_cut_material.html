
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>CH4 extra stuff &#8212; No BS Stats Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/40_extra_cut_material';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="No BS Stats Notebooks - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="No BS Stats Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    No Bullshit Guide to Statistics
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="10_DATA.html">Chapter 1 — Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="11_intro_to_data.html">Section 1.1 — Introduction to data</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_data_in_practice.html">Section 1.2 — Data in practice</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_descriptive_statistics.html">Section 1.3 — Descriptive statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/exercises_13_descr_stats.html">Descriptive statistics exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="20_PROB.html">Chapter 2 — Probability theory</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="21_discrete_random_vars.html">Section 2.1 — Discrete random variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_multiple_random_vars.html">Section 2.2 — Multiple random variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_inventory_discrete_dists.html">Section 2.3 — Inventory of discrete distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_continuous_random_vars.html">Section 2.4 — Continuous random variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="25_multiple_continuous_random_vars.html">Section 2.5 — Multiple continuous random variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_inventory_continuous_dists.html">Section 2.6 — Inventory of continuous distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="28_random_samples.html">Section 2.8 — Probability models for random samples</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="30_STATS.html">Chapter 3 — Classical statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="31_estimators.html">Section 3.1 — Estimators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/exercises_31_estimtors.html">Exercises for Section 3.1 Estimates and estimators</a></li>
<li class="toctree-l2"><a class="reference internal" href="32_confidence_intervals.html">Section 3.2 — Confidence intervals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exercises/exercises_32_confidence_intervals.html">Exercises for Section 3.2 Confidence intervals</a></li>
<li class="toctree-l2"><a class="reference internal" href="33_intro_to_NHST.html">Section 3.3 — Introduction to hypothesis testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="34_analytical_approx.html">Section 3.4 — Hypothesis testing using analytical approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="35_two_sample_tests.html">Section 3.5 — Two-sample hypothesis tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="36_design.html">Section 3.6 — Statistical design and error analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="37_inventory_stats_tests.html">Section 3.7 — Inventory of statistical tests</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../examples/README.html">Statistical analysis examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples/statistical_design.html">Statistical design examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/one_sample_z-test.html">One-sample z-test for the mean</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/one_sample_t-test.html">One-sample t-test for the mean</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/two_sample_t-test.html">Welch’s two-sample <span class="math notranslate nohighlight">\(t\)</span>-test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/ANOVA.html">Analysis of variance (ANOVA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/two_sample_equivalence_test.html">Two-sample equivalence test</a></li>

</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="40_LINEAR_MODELS.html">Chapter 4 — Linear models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="41_simple_linear_regression.html">Section 4.1 — Simple linear regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="42_multiple_linear_regression.html">Section 4.2 — Multiple linear regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="43_interpreting_linear_models.html">Section 4.3 — Interpreting linear models</a></li>
<li class="toctree-l2"><a class="reference internal" href="44_regression_with_categorical_predictors.html">Section 4.4 — Regression with categorical predictors</a></li>
<li class="toctree-l2"><a class="reference internal" href="45_causal_inference.html">Section 4.5 — Model selection for causal inference</a></li>

<li class="toctree-l2"><a class="reference internal" href="46_generalized_linear_models.html">Section 4.6 — Generalized linear models</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="50_BAYESIAN_STATS.html">Chapter 5 — Bayesian statistics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="51_intro_to_Bayesian_stats.html">Section 5.1 — Introduction to Bayesian statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="52_Bayesian_inference_computations.html">Section 5.2 — Bayesian inference computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="53_Bayesian_linear_models.html">Section 5.3 — Bayesian linear models</a></li>

<li class="toctree-l2"><a class="reference internal" href="54_difference_between_means.html">Section 5.4 — Bayesian difference between means</a></li>

<li class="toctree-l2"><a class="reference internal" href="55_hierarchical_models.html">Section 5.5 — Hierarchical models</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/appendix.html">Appendix</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/python_tutorial.html">Appendix C — Python tutorial</a></li>












<li class="toctree-l2"><a class="reference internal" href="../tutorials/pandas_tutorial.html">Appendix D — Pandas tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/seaborn_tutorial.html">Appendix E — Seaborn tutorial</a></li>

<li class="toctree-l2"><a class="reference internal" href="../tutorials/calculus_tutorial.html">Calculus tutorial</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../blogposts/index.html">Blog posts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/python_for_stats.html">Using Python for learning statistics Part 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/probability_models.html">Using Python for probability calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/sampling_distributions.html">Sampling distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/bootstrap.html">Bootstrap estimation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/simulation_hypothesis_tests.html">Hypothesis testing using simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/permutation_test.html">Permutation tests for comparing two groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/stats_procedures.html">Python libraries for doing statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blogposts/python_stats_libraries.html">Python libraries for doing statistics</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/minireference/noBSstats/main?urlpath=lab/tree/./notebooks/40_extra_cut_material.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/minireference/noBSstats" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/minireference/noBSstats/issues/new?title=Issue%20on%20page%20%2Fnotebooks/40_extra_cut_material.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/40_extra_cut_material.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>CH4 extra stuff</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#strategies-for-fitting-linear-models">Strategies for fitting linear models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-regression-plots">Partial regression plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sheffe-bands-several-different-ways">Sheffé bands (several different ways)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-predictive-accuracy">Model predictive accuracy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l1-regularization">L1 regularization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-correlation-matrix">Check the correlation matrix</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-model-fit-metrics">Other model fit metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-residual-plot">Partial residual plot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predictions-skipping-because-covered-in-sec-4-1">Predictions (skipping because covered in Sec 4.1)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#players-dataset">Players dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-linear-model-for-time-1-age">Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-linear-model-for-time-1-age-jobstatus">Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span> <span class="pre">+</span> <span class="pre">jobstatus</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-select-subset-with-jobstatus-1">Manual select subset with jobstatus 1</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-confoudouder-2">Example confoudouder  2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-slopes-and-random-intercepts">Random slopes and random intercepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-n-campaign-responses">Example N: campaign responses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-comparison-cut-material">Model comparison (CUT MATERIAL)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lagrange-multiplier-test-optional">Lagrange multiplier test (optional)</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-calculations-of-leverage-metric">Manual calculations of leverage metric</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-projection-plots">Partial projection plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-regression-plot-for-the-predictor-alc">Partial regression plot for the predictor <code class="docutils literal notranslate"><span class="pre">alc</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#old">OLD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collider-bias-via-stratification">Collider bias via stratification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glm-bonus-topics">GLM bonus topics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scikitlearn-models">ScikitLearn models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standardization-of-predictors">Standardization of predictors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effects">Marginal effects</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-parameters">Raw parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effect-at-a-user-specified-value">Marginal effect at a user-specified value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#average-marginal-effect-ame">Average marginal effect (AME)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effect-at-the-mean-mem">Marginal effect at the mean (MEM)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="ch4-extra-stuff">
<h1>CH4 extra stuff<a class="headerlink" href="#ch4-extra-stuff" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load Python modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figures setup</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># needed otherwise `sns.set_theme` doesn&#39;t work</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plot_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">RCPARAMS</span>
<span class="c1"># RCPARAMS.update({&#39;figure.figsize&#39;: (8, 6)})   # good for screen</span>
<span class="n">RCPARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)})</span>  <span class="c1"># good for print</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">RCPARAMS</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># High-resolution please</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;

<span class="c1"># Where to store figures</span>
<span class="n">DESTDIR</span> <span class="o">=</span> <span class="s2">&quot;figures/lm/interpreting&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set random seed for repeatability</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="strategies-for-fitting-linear-models">
<h2>Strategies for fitting linear models<a class="headerlink" href="#strategies-for-fitting-linear-models" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Calculus</strong>
We can obtain the analytical formulas …</p></li>
<li><p><strong>Numerical optimization</strong></p></li>
<li><p><strong>Linear algebra</strong></p></li>
</ul>
</section>
<section id="partial-regression-plots">
<h2>Partial regression plots<a class="headerlink" href="#partial-regression-plots" title="Link to this heading">#</a></h2>
<p>Imported from <a class="reference internal" href="42_multiple_linear_regression.html"><span class="std std-doc">42_multiple_linear_regression.ipynb</span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># int_weed = b0 +b_alc*means[&quot;alc&quot;]+b_exrc*means[&quot;exrc&quot;]</span>
<span class="c1"># print(f&quot;weed intercept={int_weed}, weed slope={b_weed}&quot;)</span>
<span class="c1"># weeds = np.linspace(0, doctors[&quot;weed&quot;].max())</span>
<span class="c1"># scorehats_weed = int_weed + b_weed*weeds</span>
<span class="c1"># sns.lineplot(x=weeds, y=scorehats_weed)</span>
<span class="c1"># sns.scatterplot(data=doctors, x=&quot;weed&quot;, y=&quot;score&quot;);</span>

<span class="c1"># int_exrc = b0 +b_alc*means[&quot;alc&quot;]+b_weed*means[&quot;weed&quot;]</span>
<span class="c1"># print(f&quot;exrc intercept={int_exrc}, exrc slope={b_exrc}&quot;)</span>
<span class="c1"># weeds = np.linspace(0, doctors[&quot;weed&quot;].max())</span>
<span class="c1"># scorehats_weed = int_weed + b_weed*weeds</span>
<span class="c1"># sns.lineplot(x=weeds, y=scorehats_weed)</span>
<span class="c1"># sns.scatterplot(data=doctors, x=&quot;weed&quot;, y=&quot;score&quot;);</span>


<span class="c1"># # Partial models for individual variables  (NOT THE SAME)</span>
<span class="c1"># with plt.rc_context({&quot;figure.figsize&quot;:(12,3)}):</span>
<span class="c1">#     fig, (ax1,ax2,ax3) = plt.subplots(1,3)</span>
<span class="c1">#     sns.regplot(data=doctors, x=&quot;alc&quot;, y=&quot;score&quot;,  ci=None, ax=ax1)</span>
<span class="c1">#     sns.regplot(data=doctors, x=&quot;weed&quot;, y=&quot;score&quot;, ci=None, ax=ax2)</span>
<span class="c1">#     sns.regplot(data=doctors, x=&quot;exrc&quot;, y=&quot;score&quot;, ci=None, ax=ax3)</span>
<span class="c1"># # smf.ols(&quot;score ~ 1 + alc&quot;, data=doctors).fit().params.values, \</span>
<span class="c1"># # smf.ols(&quot;score ~ 1 + weed&quot;, data=doctors).fit().params.values, \</span>
<span class="c1"># # smf.ols(&quot;score ~ 1 + exrc&quot;, data=doctors).fit().params.values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # ALT2. When exog_others is not empty, subtracts influence of others from both predictor and outcome</span>
<span class="c1"># from statsmodels.graphics.api import plot_partregress</span>
<span class="c1"># with plt.rc_context({&quot;figure.figsize&quot;:(12,3)}):</span>
<span class="c1">#     fig, (ax1,ax2,ax3) = plt.subplots(1,3, sharey=True)</span>
<span class="c1">#     plot_partregress(&quot;score&quot;, &quot;alc&quot;,  exog_others=[&quot;weed&quot;, &quot;exrc&quot;], data=doctors, obs_labels=False, ax=ax1)</span>
<span class="c1">#     plot_partregress(&quot;score&quot;, &quot;weed&quot;, exog_others=[&quot;alc&quot;, &quot;exrc&quot;], data=doctors, obs_labels=False, ax=ax2)</span>
<span class="c1">#     plot_partregress(&quot;score&quot;, &quot;exrc&quot;, exog_others=[&quot;alc&quot;, &quot;weed&quot;], data=doctors, obs_labels=False, ax=ax3)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT2B. Same as ALT2. but done in one shot</span>
<span class="c1"># from statsmodels.graphics.api import plot_partregress_grid</span>
<span class="c1"># plot_partregress_grid(lm2, [&quot;alc&quot;, &quot;weed&quot;, &quot;exrc&quot;], grid=(1,3));</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simple_regplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_pts</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">scatter_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ci_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw a regression line with error interval.</span>
<span class="sd">    via https://stackoverflow.com/a/59756979/127114</span>
<span class="sd">    See also https://github.com/ttesileanu/pydove/blob/main/pydove/regplot.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span>

    <span class="c1"># calculate best-fit line and interval</span>
    <span class="n">x_fit</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">fit_results</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x_fit</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="n">eval_x</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">n_pts</span><span class="p">))</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">eval_x</span><span class="p">)</span>

    <span class="c1"># draw the fit line and error interval</span>
    <span class="n">ci_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">ci_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ci_kws</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">eval_x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">predicted_mean</span> <span class="o">-</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">pred</span><span class="o">.</span><span class="n">se_mean</span><span class="p">,</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">predicted_mean</span> <span class="o">+</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">pred</span><span class="o">.</span><span class="n">se_mean</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="o">**</span><span class="n">ci_kws</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">line_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">line_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">line_kws</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eval_x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pred</span><span class="o">.</span><span class="n">predicted_mean</span><span class="p">,</span> <span class="o">**</span><span class="n">line_kws</span><span class="p">)</span>

    <span class="c1"># draw the scatterplot</span>
    <span class="n">scatter_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">scatter_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">scatter_kws</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span> <span class="o">**</span><span class="n">scatter_kws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit_results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SUPERSEDED BY plot_lm_simple(efforts, scores, ci_mean=True, alpha_mean=0.1)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">t</span> <span class="k">as</span> <span class="n">tdist</span>

<span class="n">students</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/students.csv&quot;</span><span class="p">)</span>
<span class="n">efforts</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>

<span class="n">n_std</span> <span class="o">=</span> <span class="n">tdist</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">simple_regplot</span><span class="p">(</span><span class="n">efforts</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="n">n_std</span><span class="p">,</span> <span class="n">ci_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;90</span><span class="si">% c</span><span class="s2">onfidence interval for the mean&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;effort&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_9513/3264559806.py:31: UserWarning: *c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2D array with a single row if you intend to specify the same RGB or RGBA value for all points.
  ax.scatter(x, y, c=h[0].get_color(), **scatter_kws)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/f56ca012c9b14dae8b0236f56e38faea6eb05ca28c18769f9f7b9f07c83ed03e.png"><img alt="../_images/f56ca012c9b14dae8b0236f56e38faea6eb05ca28c18769f9f7b9f07c83ed03e.png" src="../_images/f56ca012c9b14dae8b0236f56e38faea6eb05ca28c18769f9f7b9f07c83ed03e.png" style="width: 453px; height: 185px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SUPERSEDED BY plot_lm_simple(efforts, scores, ci_obs=True, alpha_obs=0.1)</span>
<span class="c1"># via https://discuss.python.org/t/whats-the-meaning-of-this-confidence-bands/14445/9</span>
<span class="n">sstudents</span> <span class="o">=</span> <span class="n">students</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;effort&quot;</span><span class="p">)</span>
<span class="n">efforts</span> <span class="o">=</span> <span class="n">sstudents</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">sstudents</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">efforts</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">scores</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">efforts</span><span class="p">)</span>

<span class="c1"># calculate interval manually using the formula</span>
<span class="n">lm1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;score ~ 1 + effort&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">students</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">b0</span> <span class="o">=</span> <span class="n">lm1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>  <span class="c1"># = lm1.params[0]</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">lm1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span>     <span class="c1"># = lm1.params[1]</span>
<span class="n">SSR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lm1</span><span class="o">.</span><span class="n">resid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sigmahat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">SSR</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span>
<span class="n">y_est</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">b1</span><span class="o">*</span><span class="n">x</span>

<span class="n">xdevsq</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span>
<span class="n">sxdevsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">se_yhat</span> <span class="o">=</span> <span class="n">sigmahat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="o">+</span> <span class="n">xdevsq</span><span class="o">/</span><span class="n">sxdevsq</span> <span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># plot manually calculated interval (std interval) --- the blue one</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">students</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">tstar</span> <span class="o">=</span> <span class="n">tdist</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_est</span> <span class="o">-</span> <span class="n">tstar</span><span class="o">*</span><span class="n">se_yhat</span><span class="p">,</span> <span class="n">y_est</span> <span class="o">+</span> <span class="n">tstar</span><span class="o">*</span><span class="n">se_yhat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;90% prediction confidence interval&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;effort&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/199b4d35493f827d5b87727a5ebeae3b1b89cbf545f8b5d6c738572eef221032.png"><img alt="../_images/199b4d35493f827d5b87727a5ebeae3b1b89cbf545f8b5d6c738572eef221032.png" src="../_images/199b4d35493f827d5b87727a5ebeae3b1b89cbf545f8b5d6c738572eef221032.png" style="width: 453px; height: 185px;" />
</a>
</div>
</div>
<section id="sheffe-bands-several-different-ways">
<h3>Sheffé bands (several different ways)<a class="headerlink" href="#sheffe-bands-several-different-ways" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># via https://stackoverflow.com/a/26672416/127114</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="c1">## Sample size.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1">## Predictor values.</span>
<span class="n">XV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">4</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">XV</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c1">## Design matrix.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">XV</span>

<span class="c1">## True coefficients.</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1">## True response values.</span>
<span class="n">EY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

<span class="c1">## Observed response values.</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">EY</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="c1">## Get the coefficient estimates.</span>
<span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="n">bhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>

<span class="c1">## The fitted values.</span>
<span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bhat</span><span class="p">)</span>

<span class="c1">## The MSE and RMSE.</span>
<span class="n">MSE</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span><span class="o">-</span><span class="n">EY</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">MSE</span><span class="p">)</span>

<span class="c1">## These multipliers are used in constructing the intervals.</span>
<span class="n">XtX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">XtX</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<span class="c1">## The F quantile used in constructing the Scheffe interval.</span>
<span class="n">QF</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fdtri</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">QF_2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fdtri</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.68</span><span class="p">)</span>

<span class="c1">## The lower and upper bounds of the Scheffe band.</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">QF</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">LB</span><span class="p">,</span><span class="n">UB</span> <span class="o">=</span> <span class="n">Yhat</span><span class="o">-</span><span class="n">D</span><span class="p">,</span><span class="n">Yhat</span><span class="o">+</span><span class="n">D</span>
<span class="n">D_2</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">QF_2</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">LB_2</span><span class="p">,</span><span class="n">UB_2</span> <span class="o">=</span> <span class="n">Yhat</span><span class="o">-</span><span class="n">D_2</span><span class="p">,</span><span class="n">Yhat</span><span class="o">+</span><span class="n">D_2</span>


<span class="c1">## Make the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="c1"># plt.hold(True)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">EY</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB_2</span><span class="p">,</span> <span class="n">UB_2</span><span class="p">,</span> <span class="n">where</span> <span class="o">=</span> <span class="n">UB_2</span> <span class="o">&gt;=</span> <span class="n">LB_2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB_2</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">UB_2</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="n">where</span> <span class="o">=</span> <span class="n">UB</span> <span class="o">&gt;=</span> <span class="n">LB</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Y&#39;)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/93963e15ee5c3a9386284a4096336774e53e4f01cf538fbff8a72a342bc6e12e.png"><img alt="../_images/93963e15ee5c3a9386284a4096336774e53e4f01cf538fbff8a72a342bc6e12e.png" src="../_images/93963e15ee5c3a9386284a4096336774e53e4f01cf538fbff8a72a342bc6e12e.png" style="width: 459px; height: 185px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># via https://discuss.python.org/t/whats-the-meaning-of-this-confidence-bands/14445/9</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>

<span class="c1"># calculate interval manually using the formula</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_est</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
<span class="n">y_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y_est</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># plot manually calculated interval (std interval) --- the blue one</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_est</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_est</span> <span class="o">-</span> <span class="n">y_err</span><span class="p">,</span> <span class="n">y_est</span> <span class="o">+</span> <span class="n">y_err</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># plot seaborn calculated interval (std interval, i.e. when ci=68.27) --- the orange one</span>
<span class="c1"># sns.regplot(x=x, y=y, ci=68.27)</span>

<span class="c1"># plt.text(3.5,90,&#39;blue one: using formula\norange one: using seaborn&#39;)</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.FillBetweenPolyCollection at 0x7f7719711db0&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/1983dcceb627d83703fb5cc66517f4e813b61fc08ec599261eeecd332ec8cbf7.png"><img alt="../_images/1983dcceb627d83703fb5cc66517f4e813b61fc08ec599261eeecd332ec8cbf7.png" src="../_images/1983dcceb627d83703fb5cc66517f4e813b61fc08ec599261eeecd332ec8cbf7.png" style="width: 434px; height: 167px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># via https://apmonitor.com/che263/index.php/Main/PythonRegressionStatistics</span>
<span class="c1"># see also https://www.youtube.com/watch?v=r4pgGD1kpYM</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>    
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># pip install uncertainties, if needed</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uncertainties.unumpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unp</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uncertainties</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unc</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pip</span><span class="w"> </span><span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pipmain</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pip._internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pipmain</span>
    <span class="n">pipmain</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span><span class="s1">&#39;uncertainties&#39;</span><span class="p">])</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uncertainties.unumpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unp</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uncertainties</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unc</span>

<span class="c1"># import data</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://apmonitor.com/che263/uploads/Main/stats_data.txt&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># retrieve parameter values</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimal Values&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;b: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

<span class="c1"># compute r^2</span>
<span class="n">r2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span> <span class="nb">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;R^2: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>

<span class="c1"># calculate parameter confidence interval</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">correlated_values</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Uncertainty&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;b: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

<span class="c1"># plot data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

<span class="c1"># calculate regression confidence interval</span>
<span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">py</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">px</span> <span class="o">+</span> <span class="n">b</span>
<span class="n">nom</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">nominal_values</span><span class="p">(</span><span class="n">py</span><span class="p">)</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">unp</span><span class="o">.</span><span class="n">std_devs</span><span class="p">(</span><span class="n">py</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predband</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xd</span><span class="p">,</span> <span class="n">yd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="c1"># x = requested points</span>
    <span class="c1"># xd = x data</span>
    <span class="c1"># yd = y data</span>
    <span class="c1"># p = parameters</span>
    <span class="c1"># func = function name</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span>    <span class="c1"># significance</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">xd</span><span class="o">.</span><span class="n">size</span>          <span class="c1"># data sample size</span>
    <span class="n">var_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># number of parameters</span>
    <span class="c1"># Quantile of Student&#39;s t distribution for p=(1-alpha/2)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="n">var_n</span><span class="p">)</span>
    <span class="c1"># Stdev of an individual measurement</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">var_n</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yd</span> <span class="o">-</span> <span class="n">func</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Auxiliary definitions</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xd</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">sxd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xd</span> <span class="o">-</span> <span class="n">xd</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Predicted values (best-fit model)</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="c1"># Prediction band</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">se</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sx</span><span class="o">/</span><span class="n">sxd</span><span class="p">))</span>
    <span class="c1"># Upper &amp; lower prediction bands.</span>
    <span class="n">lpb</span><span class="p">,</span> <span class="n">upb</span> <span class="o">=</span> <span class="n">yp</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="n">yp</span> <span class="o">+</span> <span class="n">dy</span>
    <span class="k">return</span> <span class="n">lpb</span><span class="p">,</span> <span class="n">upb</span>

<span class="n">lpb</span><span class="p">,</span> <span class="n">upb</span> <span class="o">=</span> <span class="n">predband</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># plot the regression</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;y=a x + b&#39;</span><span class="p">)</span>

<span class="c1"># uncertainty lines (95% confidence)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">nom</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Confidence Region&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">nom</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="c1"># prediction band (95% confidence)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">lpb</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Prediction Band&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">upb</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimal Values
a: 0.036141582136117865
b: -0.5735680930234944
R^2: 0.5278048667629538
Uncertainty
a: 0.0361+/-0.0035
b: -0.57+/-0.07
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f77197e2740&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ecad3ce3cdea53bdacb8ad1f80215a258480659e15a963db2f25026fb2ff06be.png"><img alt="../_images/ecad3ce3cdea53bdacb8ad1f80215a258480659e15a963db2f25026fb2ff06be.png" src="../_images/ecad3ce3cdea53bdacb8ad1f80215a258480659e15a963db2f25026fb2ff06be.png" style="width: 467px; height: 185px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># via https://en.m.wikipedia.org/wiki/File:Polyreg_scheffe.svg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="c1">## Sample size.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1">## Predictor values.</span>
<span class="n">XV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">4</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">XV</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c1">## Design matrix.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">XV</span>
<span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">XV</span><span class="o">**</span><span class="mi">2</span>
<span class="n">X</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">XV</span><span class="o">**</span><span class="mi">3</span>

<span class="c1">## True coefficients.</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1">## True response values.</span>
<span class="n">EY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

<span class="c1">## Observed response values.</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">EY</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="c1">## Get the coefficient estimates.</span>
<span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="n">bhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>

<span class="c1">## The fitted values.</span>
<span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bhat</span><span class="p">)</span>

<span class="c1">## The MSE and RMSE.</span>
<span class="n">MSE</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span><span class="o">-</span><span class="n">EY</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">MSE</span><span class="p">)</span>

<span class="c1">## These multipliers are used in constructing the Scheffe interval.</span>
<span class="n">XtX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">XtX</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<span class="c1">## The F quantile used in constructing the Scheffe interval.</span>
<span class="n">QF</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fdtri</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="c1">## The lower and upper bounds of the confidence band.</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">QF</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">LB</span><span class="p">,</span><span class="n">UB</span> <span class="o">=</span> <span class="n">Yhat</span><span class="o">-</span><span class="n">D</span><span class="p">,</span><span class="n">Yhat</span><span class="o">+</span><span class="n">D</span>

<span class="c1">## Make the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">EY</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Truth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Estimate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CB&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Y&#39;)
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/14db345a598630f79281afd89d5954afd042a77bdae81102634bfe01e5e7b853.png"><img alt="../_images/14db345a598630f79281afd89d5954afd042a77bdae81102634bfe01e5e7b853.png" src="../_images/14db345a598630f79281afd89d5954afd042a77bdae81102634bfe01e5e7b853.png" style="width: 467px; height: 189px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># via https://en.wikipedia.org/wiki/File:Regression_confidence_band.svg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="c1">## Sample size.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1">## Predictor values.</span>
<span class="n">XV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">4</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">XV</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c1">## Design matrix.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">XV</span>

<span class="c1">## True coefficients.</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1">## True response values.</span>
<span class="n">EY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

<span class="c1">## Observed response values.</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">EY</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="c1">## Get the coefficient estimates.</span>
<span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="n">bhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>

<span class="c1">## The fitted values.</span>
<span class="n">Yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bhat</span><span class="p">)</span>

<span class="c1">## The MSE and RMSE.</span>
<span class="n">MSE</span> <span class="o">=</span> <span class="p">((</span><span class="n">Y</span><span class="o">-</span><span class="n">EY</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">MSE</span><span class="p">)</span>

<span class="c1">## These multipliers are used in constructing the intervals.</span>
<span class="n">XtX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">X</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">XtX</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<span class="c1">## The F quantile used in constructing the Scheffe interval.</span>
<span class="n">QF</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fdtri</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="c1">## The lower and upper bounds of the Scheffe band.</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">QF</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">LB</span><span class="p">,</span><span class="n">UB</span> <span class="o">=</span> <span class="n">Yhat</span><span class="o">-</span><span class="n">D</span><span class="p">,</span><span class="n">Yhat</span><span class="o">+</span><span class="n">D</span>

<span class="c1">## The lower and upper bounds of the pointwise band.</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
<span class="n">LBP</span><span class="p">,</span><span class="n">UBP</span> <span class="o">=</span> <span class="n">Yhat</span><span class="o">-</span><span class="n">D</span><span class="p">,</span><span class="n">Yhat</span><span class="o">+</span><span class="n">D</span>

<span class="c1">## Make the plot.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="c1"># plt.hold(True)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">EY</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">UB</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">LBP</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">UBP</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XV</span><span class="p">,</span> <span class="n">Yhat</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="c1"># B = plt.legend( (a,d,b,c), (&quot;Truth&quot;, &quot;Estimate&quot;, &quot;95% simultaneous CB&quot;, &quot;95% pointwise CB&quot;) )</span>
<span class="c1"># B.draw_frame(False)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/be8469bc18382851c3e8abb8defc58e4ba61a07041e607c12db91fe2f6afc0d6.png"><img alt="../_images/be8469bc18382851c3e8abb8defc58e4ba61a07041e607c12db91fe2f6afc0d6.png" src="../_images/be8469bc18382851c3e8abb8defc58e4ba61a07041e607c12db91fe2f6afc0d6.png" style="width: 467px; height: 189px;" />
</a>
</div>
</div>
</section>
</section>
<section id="model-predictive-accuracy">
<h2>Model predictive accuracy<a class="headerlink" href="#model-predictive-accuracy" title="Link to this heading">#</a></h2>
<section id="l1-regularization">
<h3>L1 regularization<a class="headerlink" href="#l1-regularization" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">LeaveOneOut</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Generating the dataset based on your specifications</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coefs</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">n_informative</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Optimizing LASSO alpha with cross-validation</span>
<span class="n">lasso_cv</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">optimal_alpha</span> <span class="o">=</span> <span class="n">lasso_cv</span><span class="o">.</span><span class="n">alpha_</span>

<span class="c1"># Instantiating LASSO with the optimized alpha</span>
<span class="n">lasso_opt</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">optimal_alpha</span><span class="p">)</span>
<span class="n">lasso_opt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Fitting the LASSO model</span>

<span class="c1"># Instantiating and fitting Linear Regression</span>
<span class="n">linear_regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">linear_regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Evaluating optimized LASSO using LOOCV</span>
<span class="n">loo</span> <span class="o">=</span> <span class="n">LeaveOneOut</span><span class="p">()</span>
<span class="n">lasso_opt_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">lasso_opt</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">loo</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span>
<span class="n">lasso_opt_mse</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lasso_opt_scores</span><span class="p">)</span>

<span class="c1"># Evaluating Linear Regression using LOOCV</span>
<span class="n">linear_regression_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">linear_regression</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">loo</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span>
<span class="n">linear_regression_mse</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">linear_regression_scores</span><span class="p">)</span>

<span class="c1"># Printing MSE and coefficients</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal LASSO Alpha: </span><span class="si">{</span><span class="n">optimal_alpha</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimized LASSO   MSE: </span><span class="si">{</span><span class="n">lasso_opt_mse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>         <span class="sa">f</span><span class="s2">&quot;R2: </span><span class="si">{</span><span class="n">lasso_opt</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linear Regression MSE: </span><span class="si">{</span><span class="n">linear_regression_mse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;R2: </span><span class="si">{</span><span class="n">linear_regression</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Comparing coefficients</span>
<span class="c1"># print(&quot;\nCoefficients comparison:&quot;)</span>
<span class="c1"># list(zip(np.round(coefs,3),</span>
<span class="c1">#          np.round(lasso_opt.coef_,3),</span>
<span class="c1">#          np.round(linear_regression.coef_,3) ))</span>


<span class="c1"># Assuming the models have already been fit with the data</span>

<span class="c1"># Preparing the data for plotting</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Feature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Feature </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)],</span>  <span class="c1"># Adjust based on your number of features</span>
    <span class="s1">&#39;TRUE&#39;</span><span class="p">:</span> <span class="n">coefs</span><span class="p">,</span>
    <span class="s1">&#39;LASSO&#39;</span><span class="p">:</span> <span class="n">lasso_opt</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span>
    <span class="s1">&#39;Linear Regression&#39;</span><span class="p">:</span> <span class="n">linear_regression</span><span class="o">.</span><span class="n">coef_</span>
<span class="p">})</span>

<span class="c1"># Melting the DataFrame for easier plotting with Seaborn</span>
<span class="n">coefficients_melted</span> <span class="o">=</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Feature&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">)</span>

<span class="c1"># Creating the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Feature&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coefficients_melted</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparison of LASSO and Linear Regression Coefficients&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Coefficient Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Features&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimal LASSO Alpha: 0.483293
Optimized LASSO   MSE: 88.547 R2: 0.998
Linear Regression MSE: 118.439 R2: 0.999
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/92c47d8ba57db3f7b6ee9179a032ac77dc35a2a9524a4b78564012be8349d043.png"><img alt="../_images/92c47d8ba57db3f7b6ee9179a032ac77dc35a2a9524a4b78564012be8349d043.png" src="../_images/92c47d8ba57db3f7b6ee9179a032ac77dc35a2a9524a4b78564012be8349d043.png" style="width: 893px; height: 696px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %pip install biokit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from biokit.viz import corrplot</span>
<span class="c1"># doctors = pd.read_csv(&quot;../datasets/doctors.csv&quot;)</span>
<span class="c1"># c = corrplot.Corrplot(doctors[[&quot;alc&quot;, &quot;weed&quot;, &quot;exrc&quot;]])</span>
<span class="c1"># c.plot();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># c.plot(method=&#39;square&#39;);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doctors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/doctors.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="check-the-correlation-matrix">
<h4>Check the correlation matrix<a class="headerlink" href="#check-the-correlation-matrix" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corrM</span> <span class="o">=</span> <span class="n">doctors</span><span class="p">[[</span><span class="s2">&quot;alc&quot;</span><span class="p">,</span> <span class="s2">&quot;weed&quot;</span><span class="p">,</span> <span class="s2">&quot;exrc&quot;</span><span class="p">,</span><span class="s2">&quot;score&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">corrM</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>alc</th>
      <th>weed</th>
      <th>exrc</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alc</th>
      <td>1.00</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>-0.82</td>
    </tr>
    <tr>
      <th>weed</th>
      <td>0.04</td>
      <td>1.00</td>
      <td>0.10</td>
      <td>-0.06</td>
    </tr>
    <tr>
      <th>exrc</th>
      <td>0.03</td>
      <td>0.10</td>
      <td>1.00</td>
      <td>0.38</td>
    </tr>
    <tr>
      <th>score</th>
      <td>-0.82</td>
      <td>-0.06</td>
      <td>0.38</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span>
<span class="n">divnorm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">TwoSlopeNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corrM</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdYlBu&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">divnorm</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/e31dbcaf3b9080117a28f1f15698ab85a41f1dc464a7984ac3100030da4f4113.png"><img alt="../_images/e31dbcaf3b9080117a28f1f15698ab85a41f1dc464a7984ac3100030da4f4113.png" src="../_images/e31dbcaf3b9080117a28f1f15698ab85a41f1dc464a7984ac3100030da4f4113.png" style="width: 419px; height: 170px;" />
</a>
</div>
</div>
</section>
</section>
<section id="other-model-fit-metrics">
<h3>Other model fit metrics<a class="headerlink" href="#other-model-fit-metrics" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc&quot;</span>
<span class="n">lm2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># model degrees of freedom (number of predictors)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">lm2</span><span class="o">.</span><span class="n">df_model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Explained sum of squares</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">ess</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(54570.51590209804)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lm2</span><span class="o">.</span><span class="n">ssr</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">4</span><span class="p">),</span>   <span class="n">lm2</span><span class="o">.</span><span class="n">mse_resid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(222.33438116955202), np.float64(67.28540482762759))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">scoreshat</span> <span class="o">=</span> <span class="n">lm2</span><span class="o">.</span><span class="n">fittedvalues</span><span class="o">.</span><span class="n">values</span>
<span class="n">meanscore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TSS = Total Sum of Squares</span>
<span class="n">tss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">scores</span><span class="o">-</span><span class="n">meanscore</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">centered_tss</span><span class="p">,</span> <span class="n">tss</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(64797.89743589744), np.float64(64797.8974358974))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SSR = Sum of Squares Residuals</span>
<span class="n">ssr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">scores</span><span class="o">-</span><span class="n">scoreshat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
<span class="n">ssr</span><span class="p">,</span> <span class="n">lm2</span><span class="o">.</span><span class="n">ssr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(10227.381533799391), np.float64(10227.381533799393))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ESS = Explained Sum of Squares</span>
<span class="n">ess</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">scoreshat</span><span class="o">-</span><span class="n">meanscore</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> 
<span class="n">lm2</span><span class="o">.</span><span class="n">ess</span><span class="p">,</span> <span class="n">ess</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(54570.51590209804), np.float64(54570.515902097904))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MSE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools.eval_measures</span><span class="w"> </span><span class="kn">import</span> <span class="n">mse</span>
<span class="n">mse</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">scoreshat</span><span class="p">),</span> <span class="n">lm2</span><span class="o">.</span><span class="n">ssr</span><span class="o">/</span><span class="n">n</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(65.56013803717558), np.float64(204.54763067598785))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RMSE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools.eval_measures</span><span class="w"> </span><span class="kn">import</span> <span class="n">rmse</span>

<span class="n">rmse</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">scoreshat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lm2</span><span class="o">.</span><span class="n">ssr</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(8.096921516056307), np.float64(14.30201491664681))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MAE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools.eval_measures</span><span class="w"> </span><span class="kn">import</span> <span class="n">meanabs</span>

<span class="n">mae</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scores</span> <span class="o">-</span> <span class="n">scoreshat</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">meanabs</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">scoreshat</span><span class="p">),</span> <span class="n">mae</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(6.41593242149194), np.float64(20.017709155054845))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MAPE (cuttable)</span>
<span class="n">mape</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scores</span> <span class="o">-</span> <span class="n">scoreshat</span><span class="p">)</span><span class="o">/</span><span class="n">scores</span> <span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">mape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.6937156810553234)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean squared error the model</span>
<span class="c1"># The explained sum of squares divided by the model degrees of freedom</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">mse_model</span><span class="p">,</span> <span class="n">lm2</span><span class="o">.</span><span class="n">ess</span><span class="o">/</span><span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(18190.171967366015), np.float64(18190.171967366015))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean squared error of the residuals</span>
<span class="c1"># The sum of squared residuals divided by the residual degrees of freedom.</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">mse_resid</span><span class="p">,</span> <span class="n">lm2</span><span class="o">.</span><span class="n">ssr</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(67.28540482762759), np.float64(222.33438116955202))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total mean squared error</span>
<span class="c1"># The centered total sum of squares divided by the number of observations.</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">mse_total</span><span class="p">,</span> <span class="n">lm2</span><span class="o">.</span><span class="n">centered_tss</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(418.05095119933833), np.float64(1322.406070120356))
</pre></div>
</div>
</div>
</div>
<section id="partial-residual-plot">
<h4>Partial residual plot<a class="headerlink" href="#partial-residual-plot" title="Link to this heading">#</a></h4>
<p>component-plus-residual plot</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.graphics.regressionplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_partial_residuals</span>

<span class="n">plot_partial_residuals</span><span class="p">(</span><span class="n">lm2</span><span class="p">,</span> <span class="s2">&quot;alc&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/statsmodels/graphics/regressionplots.py:1199: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  focus_val = results.params[focus_col] * model.exog[:, focus_col]
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/6020f88a203b81c3a23fd76f79fc3f599daf68d991c04410ae8030ba5e65c7f8.png"><img alt="../_images/6020f88a203b81c3a23fd76f79fc3f599daf68d991c04410ae8030ba5e65c7f8.png" src="../_images/6020f88a203b81c3a23fd76f79fc3f599daf68d991c04410ae8030ba5e65c7f8.png" style="width: 471px; height: 213px;" />
</a>
</div>
</div>
</section>
</section>
<section id="predictions-skipping-because-covered-in-sec-4-1">
<h3>Predictions (skipping because covered in Sec 4.1)<a class="headerlink" href="#predictions-skipping-because-covered-in-sec-4-1" title="Link to this heading">#</a></h3>
<p>The predction</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alc&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;weed&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;exrc&quot;</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    68.177355
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_score</span> <span class="o">=</span> <span class="n">lm2</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># observation  +  90% CI</span>
<span class="n">pred_score</span><span class="o">.</span><span class="n">predicted</span><span class="p">,</span>                     <span class="c1"># predicted value</span>
<span class="n">pred_score</span><span class="o">.</span><span class="n">se_obs</span><span class="p">,</span>                        <span class="c1"># pred. std error</span>
<span class="n">pred_score</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 90% CI for value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[54.50324518, 81.85146489]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # ALT.</span>
<span class="c1"># from scipy.stats import t as tdist</span>
<span class="c1"># obs_dist = tdist(df=pred_score.df, loc=pred_score.predicted, scale=pred_score.se_obs)</span>
<span class="c1"># obs_dist.ppf(0.05), obs_dist.ppf(0.95)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_score</span><span class="o">.</span><span class="n">predicted_mean</span><span class="p">,</span>                 <span class="c1"># predicted mean</span>
<span class="n">pred_score</span><span class="o">.</span><span class="n">se_mean</span><span class="p">,</span>                        <span class="c1"># pred. mean std error</span>
<span class="n">pred_score</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 90% CI for the mean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[66.53473577, 69.81997431]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # ALT.</span>
<span class="c1"># from scipy.stats import t as tdist</span>
<span class="c1"># mean_dist = tdist(df=pred_score.df, loc=pred_score.predicted, scale=pred_score.se_mean)</span>
<span class="c1"># mean_dist.ppf(0.05), mean_dist.ppf(0.95)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ac_casino_path</span> <span class="o">=</span> <span class="s2">&quot;../../Inspiration/Data/Winner_datasets/data/ac_casino.dat&quot;</span>
<span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;Slot Handle&quot;</span><span class="p">,</span> <span class="s2">&quot;Table Drop&quot;</span><span class="p">]</span>
<span class="n">ac_casino</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">ac_casino_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ac_casino</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">ac_casino_path</span> <span class="o">=</span> <span class="s2">&quot;../../Inspiration/Data/Winner_datasets/data/ac_casino.dat&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">,</span> <span class="s2">&quot;Slot Handle&quot;</span><span class="p">,</span> <span class="s2">&quot;Table Drop&quot;</span><span class="p">]</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">ac_casino</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">ac_casino_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">ac_casino</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1565,</span> in <span class="ni">read_fwf</span><span class="nt">(filepath_or_buffer, colspecs, widths, infer_nrows, dtype_backend, iterator, chunksize, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1563</span> <span class="n">check_dtype_backend</span><span class="p">(</span><span class="n">dtype_backend</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1564</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;dtype_backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype_backend</span>
<span class="ne">-&gt; </span><span class="mi">1565</span> <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620,</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">617</span> <span class="n">_validate_names</span><span class="p">(</span><span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">619</span> <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">620</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">622</span> <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">623</span>     <span class="k">return</span> <span class="n">parser</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620,</span> in <span class="ni">TextFileReader.__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1617</span>     <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1619</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">IOHandles</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">-&gt; </span><span class="mi">1620</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880,</span> in <span class="ni">TextFileReader._make_engine</span><span class="nt">(self, f, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1878</span>     <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1879</span>         <span class="n">mode</span> <span class="o">+=</span> <span class="s2">&quot;b&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1880</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="o">=</span> <span class="n">get_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1881</span>     <span class="n">f</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1882</span>     <span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1883</span>     <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1884</span>     <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1885</span>     <span class="n">memory_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_map&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1886</span>     <span class="n">is_text</span><span class="o">=</span><span class="n">is_text</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1887</span>     <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding_errors&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1888</span>     <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;storage_options&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1889</span> <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1890</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1891</span> <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="o">.</span><span class="n">handle</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pandas/io/common.py:873,</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">868</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">869</span>     <span class="c1"># Check whether the filename is to be opened in binary mode.</span>
<span class="g g-Whitespace">    </span><span class="mi">870</span>     <span class="c1"># Binary mode does not support &#39;encoding&#39; and &#39;newline&#39;.</span>
<span class="g g-Whitespace">    </span><span class="mi">871</span>     <span class="k">if</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">and</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">872</span>         <span class="c1"># Encoding</span>
<span class="ne">--&gt; </span><span class="mi">873</span>         <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">874</span>             <span class="n">handle</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span>             <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span>             <span class="n">encoding</span><span class="o">=</span><span class="n">ioargs</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">877</span>             <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span>             <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">879</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">880</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">881</span>         <span class="c1"># Binary mode</span>
<span class="g g-Whitespace">    </span><span class="mi">882</span>         <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;../../Inspiration/Data/Winner_datasets/data/ac_casino.dat&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="players-dataset">
<h2>Players dataset<a class="headerlink" href="#players-dataset" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">players_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/players_full.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-of-linear-model-for-time-1-age">
<h3>Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span></code><a class="headerlink" href="#plot-of-linear-model-for-time-1-age" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">players_full</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x3065a3620&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/d3cf39206dff0d486f1eb992a6ecec3a3d26e734ed4cc85aec3412be2a5ace66.png"><img alt="../_images/d3cf39206dff0d486f1eb992a6ecec3a3d26e734ed4cc85aec3412be2a5ace66.png" src="../_images/d3cf39206dff0d486f1eb992a6ecec3a3d26e734ed4cc85aec3412be2a5ace66.png" style="width: 492px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">model1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;time ~ 1 + age&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">players_full</span><span class="p">)</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">result1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ivan/Projects/Minireference/STATSbook/noBSstatsnotebooks/venv/lib/python3.12/site-packages/scipy/stats/_axis_nan_policy.py:531: UserWarning: kurtosistest only valid for n&gt;=20 ... continuing anyway, n=12
  res = hypotest_fun_out(*samples, **kwds)
</pre></div>
</div>
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>time</td>       <th>  R-squared:         </th> <td>   0.260</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.186</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   3.516</td>
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 05 Sep 2024</td> <th>  Prob (F-statistic):</th>  <td>0.0902</td> 
</tr>
<tr>
  <th>Time:</th>                 <td>17:56:33</td>     <th>  Log-Likelihood:    </th> <td> -72.909</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>    12</td>      <th>  AIC:               </th> <td>   149.8</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>    10</td>      <th>  BIC:               </th> <td>   150.8</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>     <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>  403.8531</td> <td>   88.666</td> <td>    4.555</td> <td> 0.001</td> <td>  206.292</td> <td>  601.414</td>
</tr>
<tr>
  <th>age</th>       <td>   -4.5658</td> <td>    2.435</td> <td>   -1.875</td> <td> 0.090</td> <td>   -9.991</td> <td>    0.859</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td> 2.175</td> <th>  Durbin-Watson:     </th> <td>   2.490</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.337</td> <th>  Jarque-Bera (JB):  </th> <td>   0.930</td>
</tr>
<tr>
  <th>Skew:</th>          <td>-0.123</td> <th>  Prob(JB):          </th> <td>   0.628</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 1.659</td> <th>  Cond. No.          </th> <td>    97.0</td>
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
</section>
<section id="plot-of-linear-model-for-time-1-age-jobstatus">
<h3>Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span> <span class="pre">+</span> <span class="pre">jobstatus</span></code><a class="headerlink" href="#plot-of-linear-model-for-time-1-age-jobstatus" title="Link to this heading">#</a></h3>
<p>We can “control for <code class="docutils literal notranslate"><span class="pre">jobstatus</span></code>” by including the variable in the linear model.
Essentially,
we’re fitting two separate models,
one for <code class="docutils literal notranslate"><span class="pre">jobstatus=0</span></code> players and one for <code class="docutils literal notranslate"><span class="pre">jobstatus=1</span></code> players.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;jobstatus&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">players_full</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x3065d2690&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/c04e663343adf2bebad5266919ac0374b3f9b017829ef18f861ca406a8c4ac13.png"><img alt="../_images/c04e663343adf2bebad5266919ac0374b3f9b017829ef18f861ca406a8c4ac13.png" src="../_images/c04e663343adf2bebad5266919ac0374b3f9b017829ef18f861ca406a8c4ac13.png" style="width: 554px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">model2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;time ~ 1 + age + C(jobstatus)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">players_full</span><span class="p">)</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">result2</span><span class="o">.</span><span class="n">params</span>
<span class="c1"># print(result2.summary().as_text())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept            377.817172
C(jobstatus)[T.1]   -124.013781
age                   -1.650913
dtype: float64
</pre></div>
</div>
</div>
</div>
<section id="manual-select-subset-with-jobstatus-1">
<h4>Manual select subset with jobstatus 1<a class="headerlink" href="#manual-select-subset-with-jobstatus-1" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import statsmodels.formula.api as smf</span>

<span class="c1"># players_job1 = players_full[players_full[&quot;jobstatus&quot;]==1]</span>
<span class="c1"># model3 = smf.ols(&#39;time ~ 1 + age&#39;, data=players_job1)</span>
<span class="c1"># result3 = model3.fit()</span>
<span class="c1"># result3.summary()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-confoudouder-2">
<h3>Example confoudouder  2<a class="headerlink" href="#example-confoudouder-2" title="Link to this heading">#</a></h3>
<p>via <a class="reference external" href="https://stats.stackexchange.com/a/17338/62481">https://stats.stackexchange.com/a/17338/62481</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">randint</span>

<span class="n">covariate</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">exposure</span>  <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span>  <span class="mf">0.3</span> <span class="o">*</span> <span class="n">covariate</span>
<span class="n">outcome</span>   <span class="o">=</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">exposure</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">covariate</span>

<span class="c1"># covariate, exposure, outcome</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;covariate&quot;</span><span class="p">:</span><span class="n">covariate</span><span class="p">,</span>
    <span class="s2">&quot;exposure&quot;</span><span class="p">:</span><span class="n">exposure</span><span class="p">,</span>
    <span class="s2">&quot;outcome&quot;</span><span class="p">:</span><span class="n">outcome</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;outcome&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x30663d310&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/c35bf3721fc2ebb8ddb41b10010f3bebb9d83ede1311df1f933c29bdbc3c3d4e.png"><img alt="../_images/c35bf3721fc2ebb8ddb41b10010f3bebb9d83ede1311df1f933c29bdbc3c3d4e.png" src="../_images/c35bf3721fc2ebb8ddb41b10010f3bebb9d83ede1311df1f933c29bdbc3c3d4e.png" style="width: 492px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">model2a</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ exposure&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
<span class="n">result2a</span> <span class="o">=</span> <span class="n">model2a</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># result2a.summary()</span>
<span class="n">result2a</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    2.029252
exposure     0.674851
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;outcome&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;covariate&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/5c1ed685e75a15e16af0917985bb10f232fe1cdc635c4ceda96268fa2ccb412d.png"><img alt="../_images/5c1ed685e75a15e16af0917985bb10f232fe1cdc635c4ceda96268fa2ccb412d.png" src="../_images/5c1ed685e75a15e16af0917985bb10f232fe1cdc635c4ceda96268fa2ccb412d.png" style="width: 557px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2b</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ exposure + C(covariate)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
<span class="n">result2b</span> <span class="o">=</span> <span class="n">model2b</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># result2b.summary()</span>
<span class="n">result2b</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept            2.00
C(covariate)[T.1]    0.25
exposure             0.50
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.4</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">result2b</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;exposure&quot;</span><span class="p">]</span>
<span class="n">b0</span> <span class="o">=</span> <span class="n">result2b</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">result2b</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;C(covariate)[T.1]&quot;</span><span class="p">]</span>

<span class="n">b0</span><span class="p">,</span> <span class="n">b1</span>

<span class="n">y0</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fg</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;exposure&#39;, ylabel=&#39;outcome&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span><span class="o">.</span><span class="n">figure</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/4587450518f7e9ea6cdeec6c9cad19a411699a72969624a9fe252ebbce911062.png"><img alt="../_images/4587450518f7e9ea6cdeec6c9cad19a411699a72969624a9fe252ebbce911062.png" src="../_images/4587450518f7e9ea6cdeec6c9cad19a411699a72969624a9fe252ebbce911062.png" style="width: 557px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2c</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ -1 + exposure*C(covariate)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
<span class="n">result2c</span> <span class="o">=</span> <span class="n">model2c</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">result2c</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="c1"># result2c.params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>         <td>outcome</td>     <th>  R-squared:         </th> <td>   1.000</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   1.000</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>4.507e+30</td>
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 05 Sep 2024</td> <th>  Prob (F-statistic):</th>  <td>  0.00</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>17:56:34</td>     <th>  Log-Likelihood:    </th> <td>  3360.5</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td>   100</td>      <th>  AIC:               </th> <td>  -6713.</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>    96</td>      <th>  BIC:               </th> <td>  -6703.</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>     3</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
               <td></td>                 <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>C(covariate)[0]</th>            <td>    2.0000</td> <td> 1.93e-16</td> <td> 1.04e+16</td> <td> 0.000</td> <td>    2.000</td> <td>    2.000</td>
</tr>
<tr>
  <th>C(covariate)[1]</th>            <td>    2.2500</td> <td> 2.27e-16</td> <td> 9.89e+15</td> <td> 0.000</td> <td>    2.250</td> <td>    2.250</td>
</tr>
<tr>
  <th>exposure</th>                   <td>    0.5000</td> <td>  3.7e-16</td> <td> 1.35e+15</td> <td> 0.000</td> <td>    0.500</td> <td>    0.500</td>
</tr>
<tr>
  <th>exposure:C(covariate)[T.1]</th> <td> 8.882e-16</td> <td> 4.75e-16</td> <td>    1.870</td> <td> 0.065</td> <td>-5.45e-17</td> <td> 1.83e-15</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td> 5.016</td> <th>  Durbin-Watson:     </th> <td>   1.703</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.081</td> <th>  Jarque-Bera (JB):  </th> <td>   5.094</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.532</td> <th>  Prob(JB):          </th> <td>  0.0783</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 2.700</td> <th>  Cond. No.          </th> <td>    10.3</td>
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import seaborn as sns</span>
<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># df = sns.load_dataset(&#39;iris&#39;)</span>
<span class="c1"># sns.regplot(x=df[&quot;sepal_length&quot;], y=df[&quot;sepal_width&quot;], line_kws={&quot;color&quot;:&quot;r&quot;,&quot;alpha&quot;:0.7,&quot;lw&quot;:5})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="random-slopes-and-random-intercepts">
<h3>Random slopes and random intercepts<a class="headerlink" href="#random-slopes-and-random-intercepts" title="Link to this heading">#</a></h3>
<p>via <a class="reference external" href="https://patsy.readthedocs.io/en/latest/quickstart.html">https://patsy.readthedocs.io/en/latest/quickstart.html</a></p>
<p>You can even write interactions between categorical and numerical variables.
Here we fit two different slope coefficients for x1; one for the a1 group, and one for the a2 group:
<code class="docutils literal notranslate"><span class="pre">dmatrix(&quot;a:x1&quot;,</span> <span class="pre">data)</span></code></p>
<p>This is what matches the seaborn plot when using <code class="docutils literal notranslate"><span class="pre">hue</span></code> as an extra variable</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2d</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ 1 + C(covariate) + C(covariate):exposure&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df2</span><span class="p">)</span>
<span class="n">result2d</span> <span class="o">=</span> <span class="n">model2d</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># result2d.summary()</span>
<span class="n">result2d</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept                   2.00
C(covariate)[T.1]           0.25
C(covariate)[0]:exposure    0.50
C(covariate)[1]:exposure    0.50
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">randint</span>

<span class="n">covariate3</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">exposure3</span>  <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span>  <span class="mf">0.3</span> <span class="o">*</span> <span class="n">covariate</span>
<span class="n">outcome3</span>   <span class="o">=</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">covariate3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">covariate3</span><span class="p">)</span><span class="o">*</span><span class="n">exposure3</span> 
<span class="c1">#                  \             /    \                  /</span>
<span class="c1">#                  different inst.      different slopes  </span>

<span class="n">df3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;covariate&quot;</span><span class="p">:</span><span class="n">covariate3</span><span class="p">,</span>
    <span class="s2">&quot;exposure&quot;</span><span class="p">:</span><span class="n">exposure3</span><span class="p">,</span>
    <span class="s2">&quot;outcome&quot;</span><span class="p">:</span><span class="n">outcome3</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;outcome&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;covariate&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/7d1130dfad392d1346233787a34fc86c5d7e491bd3930f28341bea1c96b26fcc.png"><img alt="../_images/7d1130dfad392d1346233787a34fc86c5d7e491bd3930f28341bea1c96b26fcc.png" src="../_images/7d1130dfad392d1346233787a34fc86c5d7e491bd3930f28341bea1c96b26fcc.png" style="width: 557px; height: 491px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model3d</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ 1 + C(covariate) + C(covariate):exposure&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df3</span><span class="p">)</span>
<span class="n">result3d</span> <span class="o">=</span> <span class="n">model3d</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">result3d</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept                   2.00
C(covariate)[T.1]           0.25
C(covariate)[0]:exposure    0.50
C(covariate)[1]:exposure    0.60
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT.</span>
<span class="n">model3e</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;outcome ~ 0 + C(covariate) + C(covariate):exposure&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df3</span><span class="p">)</span>
<span class="n">result3e</span> <span class="o">=</span> <span class="n">model3e</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">result3e</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C(covariate)[0]             2.00
C(covariate)[1]             2.25
C(covariate)[0]:exposure    0.50
C(covariate)[1]:exposure    0.60
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-n-campaign-responses">
<h3>Example N: campaign responses<a class="headerlink" href="#example-n-campaign-responses" title="Link to this heading">#</a></h3>
<p>via <a class="reference internal" href="#./explorations/logistic-regression-python-implementation.ipynb"><span class="xref myst">logistic-regression-python-implementation.ipynb</span></a></p>
<p>see also <a class="reference internal" href="#./explorations/marketing-eda-stats-prediction-accuracy-100.ipynb"><span class="xref myst">marketing-eda-stats-prediction-accuracy-100.ipynb</span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="c1"># data = pd.read_csv(&quot;/kaggle/input/marketing-campaign-positive-response-prediction/campaign_responses.csv&quot;)</span>
<span class="n">campresp_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./explorations/data/campaign_responses.csv&quot;</span><span class="p">)</span>
<span class="c1"># campresp.drop(&#39;customer_id&#39;, axis=1, inplace=True)</span>
<span class="n">campresp_raw</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>age</th>
      <th>gender</th>
      <th>annual_income</th>
      <th>credit_score</th>
      <th>employed</th>
      <th>marital_status</th>
      <th>no_of_children</th>
      <th>responded</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>35</td>
      <td>Male</td>
      <td>65000</td>
      <td>720</td>
      <td>Yes</td>
      <td>Married</td>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>28</td>
      <td>Female</td>
      <td>45000</td>
      <td>680</td>
      <td>No</td>
      <td>Single</td>
      <td>0</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>42</td>
      <td>Male</td>
      <td>85000</td>
      <td>750</td>
      <td>Yes</td>
      <td>Married</td>
      <td>3</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">campresp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">column</span> <span class="o">-</span> <span class="n">column</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">column</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># standardize numerical columns</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize</span><span class="p">(</span><span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">])</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;annual_income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize</span><span class="p">(</span><span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;annual_income&quot;</span><span class="p">])</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;credit_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize</span><span class="p">(</span><span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;credit_score&quot;</span><span class="p">])</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;no_of_children&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize</span><span class="p">(</span><span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;no_of_children&quot;</span><span class="p">])</span>

<span class="c1"># copy over categorical</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;employed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;employed&quot;</span><span class="p">]</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;marital_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;marital_status&quot;</span><span class="p">]</span>
<span class="n">campresp</span><span class="p">[</span><span class="s2">&quot;responded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campresp_raw</span><span class="p">[</span><span class="s2">&quot;responded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;Yes&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>

<span class="n">campresp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/yp/48zx9brn6mj6vmy50smb844w0000gn/T/ipykernel_10786/1604395620.py:15: FutureWarning: Downcasting behavior in `replace` is deprecated and will be removed in a future version. To retain the old behavior, explicitly call `result.infer_objects(copy=False)`. To opt-in to the future behavior, set `pd.set_option(&#39;future.no_silent_downcasting&#39;, True)`
  campresp[&quot;responded&quot;] = campresp_raw[&quot;responded&quot;].replace({&quot;Yes&quot;:1, &quot;No&quot;:0})
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>annual_income</th>
      <th>credit_score</th>
      <th>no_of_children</th>
      <th>gender</th>
      <th>employed</th>
      <th>marital_status</th>
      <th>responded</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.172859</td>
      <td>-0.177936</td>
      <td>0.014931</td>
      <td>0.607457</td>
      <td>Male</td>
      <td>Yes</td>
      <td>Married</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.169337</td>
      <td>-1.063659</td>
      <td>-0.653970</td>
      <td>-1.093422</td>
      <td>Female</td>
      <td>No</td>
      <td>Single</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.823620</td>
      <td>0.707788</td>
      <td>0.516607</td>
      <td>1.457896</td>
      <td>Male</td>
      <td>Yes</td>
      <td>Married</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.742275</td>
      <td>-0.620797</td>
      <td>-0.152294</td>
      <td>-0.242983</td>
      <td>Female</td>
      <td>Yes</td>
      <td>Single</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.535390</td>
      <td>1.150650</td>
      <td>1.185508</td>
      <td>0.607457</td>
      <td>Male</td>
      <td>Yes</td>
      <td>Married</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formula = &quot;responded ~ 1 + age + C(gender) + annual_income + credit_score + C(employed) + C(marital_status) + no_of_children&quot;</span>
<span class="c1"># lrcampresp = smf.logit(formula, data=campresp).fit(method=&quot;lbfgs&quot;)</span>
<span class="c1"># lrcampresp.params</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lrcampresp.model.exog.round(3)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># w = [ 0.17016481  0.06417441 -0.17534414  0.26848132  0.29103447  0.27035385</span>
<span class="c1">#   0.29485787], b = -0.005179325656765166</span>
<span class="c1"># 1.0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-comparison-cut-material">
<h3>Model comparison (CUT MATERIAL)<a class="headerlink" href="#model-comparison-cut-material" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the doctors data set</span>
<span class="n">doctors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/doctors.csv&quot;</span><span class="p">)</span>

<span class="c1"># fit the short model</span>
<span class="n">formula2</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc&quot;</span>
<span class="n">lm2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula2</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># fit long model with caffeine</span>
<span class="n">formula2c</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc + caf&quot;</span>
<span class="n">lm2c</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula2c</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># fit long model with useless varaible</span>
<span class="n">formula2p</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc + permit&quot;</span>
<span class="n">lm2p</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula2p</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>


<span class="c1"># fit long model with hours</span>
<span class="n">formula2h</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc + hours&quot;</span>
<span class="n">lm2h</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula2h</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="lagrange-multiplier-test-optional">
<h4>Lagrange multiplier test (optional)<a class="headerlink" href="#lagrange-multiplier-test-optional" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># workaround to avoid bug</span>
<span class="n">lm2_np</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">lm2</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="n">lm2</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm2c_np</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">lm2c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="n">lm2c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Lagrange Multiplier test to check short model</span>
<span class="n">lm2c_np</span><span class="o">.</span><span class="n">compare_lm_test</span><span class="p">(</span><span class="n">lm2_np</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(12.643516756348593, 0.00037687035845299126, 1.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">doctors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/doctors.csv&quot;</span><span class="p">)</span>
<span class="n">formula3</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc + C(loc)&quot;</span>
<span class="n">lm3</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># HOW TO GET DESIGN MATRIX INFO</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vardict</span> <span class="ow">in</span> <span class="n">lm3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">factor_infos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;type:&quot;</span><span class="p">,</span> <span class="n">vardict</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vardict</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
        <span class="n">slicer</span> <span class="o">=</span> <span class="n">lm3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="s2">&quot;C(loc)&quot;</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">lm3</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span><span class="p">[</span><span class="n">slicer</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>alc
type: numerical

weed
type: numerical

exrc
type: numerical

C(loc)
type: categorical
[&#39;C(loc)[T.urb]&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># workaround to avoid RuntimeWarning: invalid value encountered in divide</span>
<span class="c1"># nzwdocs = doctors[doctors[&quot;weed&quot;] != 0]</span>
<span class="c1"># zwdocs = doctors[doctors[&quot;weed&quot;] == 0]</span>
<span class="c1"># n_subsample = int(0.4*len(zwdocs))</span>
<span class="c1"># np.random.seed(42)</span>
<span class="c1"># zwdocs_subsample = zwdocs.sample(n_subsample)</span>
<span class="c1"># idxs = np.concatenate((nzwdocs.index, zwdocs_subsample.index))</span>
<span class="c1"># sns.regplot(x=doctors[&quot;weed&quot;][idxs], y=lm2.resid[idxs], lowess=True, scatter_kws={&#39;s&#39;:8}, ax=axs[1])</span>
<span class="c1"># ALT.</span>
<span class="c1"># doctors_alt = doctors.loc[idxs]</span>
<span class="c1"># formula = &quot;score ~ 1 + alc + weed + exrc&quot;</span>
<span class="c1"># lm2_alt = smf.ols(formula, data=doctors_alt).fit()    </span>
<span class="c1"># plot_resid(lm2, &quot;weed&quot;, lowess=True, ax=axs[1])</span>

<span class="c1"># Fixes instead by increasing `frac` to 0.72 (higher than default 2/3)</span>
</pre></div>
</div>
</div>
</div>
<section id="manual-calculations-of-leverage-metric">
<h5>Manual calculations of leverage metric<a class="headerlink" href="#manual-calculations-of-leverage-metric" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtcars</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_rdataset</span><span class="p">(</span><span class="s2">&quot;mtcars&quot;</span><span class="p">,</span> <span class="s2">&quot;datasets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Fit model using all data points</span>
<span class="n">lmcars</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mtcars</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Design matrix</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">mtcars</span><span class="p">[</span><span class="s2">&quot;hp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Hat matrix</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># First element of the diagonal form the hat matrix</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">H</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h0</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Linear model fit without the first data point</span>
<span class="n">lmcars_no0</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;mpg ~ hp&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mtcars</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Prediction of yhat0 from the model without the first data point</span>
<span class="n">yhat0_no0</span> <span class="o">=</span> <span class="n">lmcars_no0</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s2">&quot;hp&quot;</span><span class="p">:</span><span class="n">mtcars</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;hp&quot;</span><span class="p">]})[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">yhat0_no0</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Alternative formula   h0 = 1 - r0 / r0_no0</span>
<span class="n">r0</span> <span class="o">=</span> <span class="n">lmcars</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="c1"># residual from the full model </span>
<span class="n">r0_no0</span> <span class="o">=</span> <span class="n">lmcars_no0</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># residual from model w/o first point</span>
<span class="n">h0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">r0</span><span class="o">/</span><span class="n">r0_no0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h0</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Alternative formula for h0 via `statsmodels`</span>
<span class="n">infl_cars</span> <span class="o">=</span> <span class="n">lmcars</span><span class="o">.</span><span class="n">get_influence</span><span class="p">()</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">infl_cars</span><span class="o">.</span><span class="n">hat_matrix_diag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h0</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>h0 = 0.040486269262275776
yhat0_no0 = 22.66099754562672
h0 = 0.040486269262268504
h0 = 0.04048626926227573
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="partial-projection-plots">
<h2>Partial projection plots<a class="headerlink" href="#partial-projection-plots" title="Link to this heading">#</a></h2>
<section id="partial-regression-plot-for-the-predictor-alc">
<h3>Partial regression plot for the predictor <code class="docutils literal notranslate"><span class="pre">alc</span></code><a class="headerlink" href="#partial-regression-plot-for-the-predictor-alc" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">doctors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/doctors.csv&quot;</span><span class="p">)</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;score ~ 1 + alc + weed + exrc&quot;</span>
<span class="n">lm2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm2</span><span class="o">.</span><span class="n">params</span>

<span class="n">b0</span><span class="p">,</span> <span class="n">b_alc</span><span class="p">,</span> <span class="n">b_weed</span><span class="p">,</span> <span class="n">b_exrc</span> <span class="o">=</span> <span class="n">lm2</span><span class="o">.</span><span class="n">params</span>
<span class="n">avg_weed</span> <span class="o">=</span> <span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;weed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">avg_exrc</span> <span class="o">=</span> <span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;exrc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">avg_weed</span><span class="p">,</span> <span class="n">avg_exrc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.6282051282051282, 5.387820512820513)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># FIXME</span>
<span class="n">int_alc</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">b_weed</span><span class="o">*</span><span class="n">avg_weed</span> <span class="o">+</span> <span class="n">b_exrc</span><span class="o">*</span><span class="n">avg_exrc</span>
<span class="n">int_alc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>69.33837903371315
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">alcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;alc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">scorehats_alc</span> <span class="o">=</span> <span class="n">int_alc</span> <span class="o">+</span> <span class="n">b_alc</span><span class="o">*</span><span class="n">alcs</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alcs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scorehats_alc</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">doctors</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;alc&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png"><img alt="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png" src="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png" style="width: 456px; height: 187px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ministats</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_projreg</span>
<span class="n">plot_projreg</span><span class="p">(</span><span class="n">lm2</span><span class="p">,</span> <span class="s2">&quot;alc&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>alc intercept= 69.33837903371315 slope= -1.8001013152459422
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png"><img alt="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png" src="../_images/5539de51a67eb7b0f016293a6ccc5aa0ed567ab37bf38fee54d026a97ab6f952.png" style="width: 456px; height: 187px;" />
</a>
</div>
</div>
</section>
<section id="old">
<h3>OLD<a class="headerlink" href="#old" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot_lm_partial_old(lm2, &quot;exrc&quot;)</span>
<span class="c1"># sns.scatterplot(data=doctors, x=&quot;exrc&quot;, y=&quot;score&quot;);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # leave simplified version after split to figures only</span>

<span class="c1"># from ministats.plots import plot_lm_partial_old</span>

<span class="c1"># with plt.rc_context({&quot;figure.figsize&quot;:(6.2,2)}):</span>
<span class="c1">#     fig, (ax1,ax2,ax3) = plt.subplots(1,3, sharey=True)</span>
<span class="c1">#     # alc</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;alc&quot;, y=&quot;score&quot;, s=5, ax=ax1)</span>
<span class="c1">#     ax1.set_xticks([0,10,20,30,40])</span>
<span class="c1">#     plot_lm_partial_old(lm2, &quot;alc&quot;, ax=ax1)</span>
<span class="c1">#     # weed</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;weed&quot;, y=&quot;score&quot;, s=5, ax=ax2)</span>
<span class="c1">#     ax2.set_xticks([0,2,4,6,8,10])</span>
<span class="c1">#     plot_lm_partial_old(lm2, &quot;weed&quot;, ax=ax2)</span>
<span class="c1">#     # exrc</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;exrc&quot;, y=&quot;score&quot;, s=5, ax=ax3)</span>
<span class="c1">#     ax3.set_xticks([0,5,10,15,20])</span>
<span class="c1">#     plot_lm_partial_old(lm2, &quot;exrc&quot;, ax=ax3)</span>

<span class="c1">#     filename = os.path.join(DESTDIR, &quot;prediction_score_vs_alc_weed_exrc.pdf&quot;)</span>
<span class="c1">#     savefigure(plt.gcf(), filename)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)}):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs_matrix</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">.4</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">axs_matrix</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;alc&quot;</span><span class="p">],</span>   <span class="n">y</span><span class="o">=</span><span class="n">lm2</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">)</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;weed&quot;</span><span class="p">],</span>  <span class="n">y</span><span class="o">=</span><span class="n">lm2</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">doctors</span><span class="p">[</span><span class="s2">&quot;exrc&quot;</span><span class="p">],</span>  <span class="n">y</span><span class="o">=</span><span class="n">lm2</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;resid&quot;</span><span class="p">)</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lm2</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">lm2</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;fitted values&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

    <span class="c1"># filename = os.path.join(DESTDIR, &quot;sleep_scores_resid_vs_vars_2x2_panel.pdf&quot;)</span>
    <span class="c1"># savefigure(fig, filename)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/26b41827a718a84a1a4dc9809950af6bc943adc8a493a54e6c73533f01e248cc.png"><img alt="../_images/26b41827a718a84a1a4dc9809950af6bc943adc8a493a54e6c73533f01e248cc.png" src="../_images/26b41827a718a84a1a4dc9809950af6bc943adc8a493a54e6c73533f01e248cc.png" style="width: 535px; height: 370px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># formula3 = &quot;score ~ 1 + alc + weed + exrc + C(loc)&quot;</span>
<span class="c1"># lm3 = smf.ols(formula3, data=doctors).fit()</span>
<span class="c1"># lm3.params</span>


<span class="c1"># from ministats.plots.cut_material import plot_projreg_cat</span>
<span class="c1"># # TODO: change legend to show line styles not color</span>
<span class="c1"># with plt.rc_context({&quot;figure.figsize&quot;:(6.2,2)}):</span>
<span class="c1">#     fig, (ax1,ax2,ax3) = plt.subplots(1,3, sharey=True)</span>

<span class="c1">#     # alc</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;alc&quot;, y=&quot;score&quot;, hue=&quot;loc&quot;, s=5, ax=ax1)</span>
<span class="c1">#     ax1.set_xticks([0,10,20,30,40])</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;alc&quot;, cats=[], color=&quot;C0&quot;, ax=ax1)</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;alc&quot;, cats=[&quot;C(loc)[T.urb]&quot;], color=&quot;C1&quot;, linestyle=&quot;dashed&quot;, ax=ax1)</span>

<span class="c1">#     # weed</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;weed&quot;, y=&quot;score&quot;, hue=&quot;loc&quot;, s=5, ax=ax2)</span>
<span class="c1">#     ax2.set_xticks([0,2,4,6,8,10])</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;weed&quot;, cats=[], color=&quot;C0&quot;, ax=ax2)</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;weed&quot;, cats=[&quot;C(loc)[T.urb]&quot;], color=&quot;C1&quot;, linestyle=&quot;dashed&quot;, ax=ax2)</span>

<span class="c1">#     # exrc</span>
<span class="c1">#     sns.scatterplot(data=doctors, x=&quot;exrc&quot;, y=&quot;score&quot;, hue=&quot;loc&quot;, s=5, ax=ax3)</span>
<span class="c1">#     ax3.set_xticks([0,5,10,15,20])</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;exrc&quot;, cats=[], color=&quot;C0&quot;, ax=ax3)</span>
<span class="c1">#     plot_projreg_cat(lm3, &quot;exrc&quot;, cats=[&quot;C(loc)[T.urb]&quot;], color=&quot;C1&quot;, linestyle=&quot;dashed&quot;, ax=ax3)</span>

<span class="c1">#     filename = os.path.join(DESTDIR, &quot;partial_reg_score_vs_alc_weed_exrc_for_locs.pdf&quot;)</span>
<span class="c1">#     savefigure(plt.gcf(), filename)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="collider-bias-via-stratification">
<h3>Collider bias via stratification<a class="headerlink" href="#collider-bias-via-stratification" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">zs</span> <span class="o">=</span> <span class="p">(</span><span class="n">xs</span> <span class="o">+</span> <span class="n">ys</span> <span class="o">&gt;=</span> <span class="mf">1.7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ys</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">zs</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>If we choose to control for <code class="docutils literal notranslate"><span class="pre">z</span></code> using stratification,we’ll find there is a negative association,
in both sub-samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df5z0</span> <span class="o">=</span> <span class="n">df5</span><span class="p">[</span><span class="n">df5</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lm5z0</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;y ~ 1 + x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df5z0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm5z0</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept   -0.164016
x           -0.197910
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df5z1</span> <span class="o">=</span> <span class="n">df5</span><span class="p">[</span><span class="n">df5</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">lm5z1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;y ~ 1 + x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df5z1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm5z1</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    2.032647
x           -0.666737
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df5z0</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z=0&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df5z1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;linestyle&quot;</span><span class="p">:</span><span class="s2">&quot;dashed&quot;</span><span class="p">},</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;z=1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/ed052d2c2d9975842f7fe483e5708ba50747d2767b0f1cc781ad86e4708ca785.png"><img alt="../_images/ed052d2c2d9975842f7fe483e5708ba50747d2767b0f1cc781ad86e4708ca785.png" src="../_images/ed052d2c2d9975842f7fe483e5708ba50747d2767b0f1cc781ad86e4708ca785.png" style="width: 451px; height: 185px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">examanx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./explorations/data/ExamAnxiety.dat&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;Code&quot;</span><span class="p">)</span>
<span class="n">examanx</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Revise</th>
      <th>Exam</th>
      <th>Anxiety</th>
      <th>Gender</th>
    </tr>
    <tr>
      <th>Code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>40</td>
      <td>86.298</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11</td>
      <td>65</td>
      <td>88.716</td>
      <td>Female</td>
    </tr>
    <tr>
      <th>3</th>
      <td>27</td>
      <td>80</td>
      <td>70.178</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>4</th>
      <td>53</td>
      <td>80</td>
      <td>61.312</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4</td>
      <td>40</td>
      <td>89.522</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>99</th>
      <td>13</td>
      <td>55</td>
      <td>70.984</td>
      <td>Female</td>
    </tr>
    <tr>
      <th>100</th>
      <td>14</td>
      <td>75</td>
      <td>78.238</td>
      <td>Female</td>
    </tr>
    <tr>
      <th>101</th>
      <td>1</td>
      <td>2</td>
      <td>82.268</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>102</th>
      <td>9</td>
      <td>40</td>
      <td>79.044</td>
      <td>Male</td>
    </tr>
    <tr>
      <th>103</th>
      <td>20</td>
      <td>50</td>
      <td>91.134</td>
      <td>Female</td>
    </tr>
  </tbody>
</table>
<p>103 rows × 4 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pingouin</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pg</span>
<span class="n">examanx</span><span class="o">.</span><span class="n">pcorr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Revise</th>
      <th>Exam</th>
      <th>Anxiety</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Revise</th>
      <td>1.000000</td>
      <td>0.132678</td>
      <td>-0.648530</td>
    </tr>
    <tr>
      <th>Exam</th>
      <td>0.132678</td>
      <td>1.000000</td>
      <td>-0.246666</td>
    </tr>
    <tr>
      <th>Anxiety</th>
      <td>-0.648530</td>
      <td>-0.246666</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pc</span> <span class="o">=</span> <span class="n">examanx</span><span class="o">.</span><span class="n">pcorr</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Exam&quot;</span><span class="p">,</span> <span class="s2">&quot;Anxiety&quot;</span><span class="p">]</span>
<span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.2466658202461243, 0.0608440268776933)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmA</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;Anxiety ~ 1 + Revise&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">examanx</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">rA</span> <span class="o">=</span> <span class="n">lmA</span><span class="o">.</span><span class="n">resid</span>

<span class="n">lmE</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;Exam ~ 1 + Revise&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">examanx</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">rE</span> <span class="o">=</span> <span class="n">lmE</span><span class="o">.</span><span class="n">resid</span>

<span class="n">dfrEA</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;rA&quot;</span><span class="p">:</span><span class="n">rA</span><span class="p">,</span> <span class="s2">&quot;rE&quot;</span><span class="p">:</span><span class="n">rE</span><span class="p">})</span>
<span class="n">lmEA</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;rE ~ 0 + rA&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dfrEA</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lmEA</span><span class="o">.</span><span class="n">rsquared</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.06084402687769341
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="glm-bonus-topics">
<h2>GLM bonus topics<a class="headerlink" href="#glm-bonus-topics" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">interns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/interns.csv&quot;</span><span class="p">)</span>
<span class="n">hdisks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../datasets/hdisks.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="n">lr1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="s2">&quot;hired ~ 1 + work&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">interns</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">pr2</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="s2">&quot;failures ~ 1 + age&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">hdisks</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.138101
         Iterations 10
Optimization terminated successfully.
         Current function value: 2.693129
         Iterations 6
</pre></div>
</div>
</div>
</div>
<section id="scikitlearn-models">
<h3>ScikitLearn models<a class="headerlink" href="#scikitlearn-models" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cross check with sklearn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="n">X1_skl</span> <span class="o">=</span> <span class="n">interns</span><span class="p">[[</span><span class="s2">&quot;work&quot;</span><span class="p">]]</span>
<span class="n">y1_skl</span> <span class="o">=</span> <span class="n">interns</span><span class="p">[</span><span class="s2">&quot;hired&quot;</span><span class="p">]</span>
<span class="n">lr1_skl</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X1_skl</span><span class="p">,</span> <span class="n">y1_skl</span><span class="p">)</span>
<span class="n">lr1_skl</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">lr1_skl</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-78.69320824]), array([[1.98145785]]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr1</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept   -78.693205
work          1.981458
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">PoissonRegressor</span>
<span class="n">X2_skl</span> <span class="o">=</span> <span class="n">hdisks</span><span class="p">[[</span><span class="s2">&quot;age&quot;</span><span class="p">]]</span>
<span class="n">y2_skl</span> <span class="o">=</span> <span class="n">hdisks</span><span class="p">[</span><span class="s2">&quot;failures&quot;</span><span class="p">]</span>
<span class="n">pr2_skl</span> <span class="o">=</span> <span class="n">PoissonRegressor</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X2_skl</span><span class="p">,</span> <span class="n">y2_skl</span><span class="p">)</span>
<span class="n">pr2_skl</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">pr2_skl</span><span class="o">.</span><span class="n">coef_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.0759942750890905, array([0.19382823]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pr2</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    1.075999
age          0.193828
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="standardization-of-predictors">
<h3>Standardization of predictors<a class="headerlink" href="#standardization-of-predictors" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>

<span class="n">students</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../datasets/students.csv&#39;</span><span class="p">)</span>
<span class="n">efforts</span> <span class="o">=</span> <span class="n">students</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span>
<span class="n">zefforts</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">efforts</span><span class="p">)</span>
<span class="n">zefforts</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    1.092044
1   -0.114057
2   -0.161876
Name: effort, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # ALT. define custom function equivalent to zscore(data)</span>
<span class="c1"># def standardize(data):</span>
<span class="c1">#     datamean = data.mean()</span>
<span class="c1">#     datastd = data.std(ddof=1)</span>
<span class="c1">#     zdata = (data - datamean) / datastd</span>
<span class="c1">#     return zdata</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">students</span><span class="p">[</span><span class="s2">&quot;zeffort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zefforts</span>
<span class="n">lm1s</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;score~1+zeffort&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">students</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm1s</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    72.580000
zeffort       8.478568
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lm1s</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;zeffort&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">students</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.50485034420907
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lm1</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;score~1+effort&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">students</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">lm1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.504850344209077
</pre></div>
</div>
</div>
</div>
</section>
<section id="marginal-effects">
<h3>Marginal effects<a class="headerlink" href="#marginal-effects" title="Link to this heading">#</a></h3>
<p>It can be difficult to interpret GLM parameters directly,
but we can always ask the question about “slopes”
the rate of change of interesting parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">marginaleffects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">me</span>
</pre></div>
</div>
</div>
</div>
<section id="raw-parameters">
<h4>Raw parameters<a class="headerlink" href="#raw-parameters" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">lr1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lr1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.9814577697476365, 7.253308936265489)
</pre></div>
</div>
</div>
</div>
<p>The parameter tells us the log-odds ratio changes by 1.981,
or equivalently,
that the odd-ratio changes by a factor of 7.253 for each additional hour of <code class="docutils literal notranslate"><span class="pre">work</span></code>.</p>
</section>
<section id="marginal-effect-at-a-user-specified-value">
<h4>Marginal effect at a user-specified value<a class="headerlink" href="#marginal-effect-at-a-user-specified-value" title="Link to this heading">#</a></h4>
<p><strong>Example</strong> To calculate the marginal effect of the predictor <code class="docutils literal notranslate"><span class="pre">work</span></code>
for an intern who invests 40 hours of effort.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using `statsmodels`</span>
<span class="n">lr1</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">(</span><span class="n">atexog</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="mi">40</span><span class="p">})</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dy/dx</th>
      <th>Std. Err.</th>
      <th>z</th>
      <th>Pr(&gt;|z|)</th>
      <th>Conf. Int. Low</th>
      <th>Cont. Int. Hi.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>work</th>
      <td>0.45783</td>
      <td>0.112623</td>
      <td>4.065157</td>
      <td>0.000048</td>
      <td>0.237093</td>
      <td>0.678567</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT. using `marginaleffects`</span>
<span class="n">dg40</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">datagrid</span><span class="p">(</span><span class="n">lr1</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">])</span>
<span class="n">me</span><span class="o">.</span><span class="n">slopes</span><span class="p">(</span><span class="n">lr1</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">dg40</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>term</th>
      <th>contrast</th>
      <th>estimate</th>
      <th>std_error</th>
      <th>statistic</th>
      <th>p_value</th>
      <th>s_value</th>
      <th>conf_low</th>
      <th>conf_high</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>work</td>
      <td>dY/dX</td>
      <td>0.45783</td>
      <td>0.112607</td>
      <td>4.065745</td>
      <td>0.000048</td>
      <td>14.350241</td>
      <td>0.237125</td>
      <td>0.678535</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT2. manual calculation plugging into derivative of `expit`</span>
<span class="n">p40</span> <span class="o">=</span> <span class="n">lr1</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s2">&quot;work&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">})</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">marg_effect_at_40</span> <span class="o">=</span> <span class="n">p40</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p40</span><span class="p">)</span> <span class="o">*</span> <span class="n">lr1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;work&#39;</span><span class="p">]</span>
<span class="n">marg_effect_at_40</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4578299798991836
</pre></div>
</div>
</div>
</div>
</section>
<section id="average-marginal-effect-ame">
<h4>Average marginal effect (AME)<a class="headerlink" href="#average-marginal-effect-ame" title="Link to this heading">#</a></h4>
<p>For each observation <span class="math notranslate nohighlight">\((w_i,h_i)\)</span>,
compute the marginal effect at <span class="math notranslate nohighlight">\(w=w_i\)</span>,
then average them together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr1</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">()</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dy/dx</th>
      <th>Std. Err.</th>
      <th>z</th>
      <th>Pr(&gt;|z|)</th>
      <th>Conf. Int. Low</th>
      <th>Cont. Int. Hi.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>work</th>
      <td>0.08077</td>
      <td>0.00422</td>
      <td>19.139418</td>
      <td>1.185874e-81</td>
      <td>0.072499</td>
      <td>0.089041</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT. using the `marginaleffects` package</span>
<span class="n">me</span><span class="o">.</span><span class="n">avg_slopes</span><span class="p">(</span><span class="n">lr1</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>term</th>
      <th>contrast</th>
      <th>estimate</th>
      <th>std_error</th>
      <th>statistic</th>
      <th>p_value</th>
      <th>s_value</th>
      <th>conf_low</th>
      <th>conf_high</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>work</td>
      <td>mean(dY/dX)</td>
      <td>0.08077</td>
      <td>0.00422</td>
      <td>19.140526</td>
      <td>0.0</td>
      <td>inf</td>
      <td>0.072499</td>
      <td>0.089041</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT2. manual computation using a for-loop</span>
<span class="n">meffects</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">interns</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">lr1</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s2">&quot;work&quot;</span><span class="p">:</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">]})</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">meffect</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">lr1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;work&#39;</span><span class="p">]</span>
    <span class="n">meffects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meffect</span><span class="p">)</span>
<span class="n">AME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">meffects</span><span class="p">)</span>
<span class="n">AME</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.08076985840552185
</pre></div>
</div>
</div>
</div>
</section>
<section id="marginal-effect-at-the-mean-mem">
<h4>Marginal effect at the mean (MEM)<a class="headerlink" href="#marginal-effect-at-the-mean-mem" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr1</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">(</span><span class="n">at</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dy/dx</th>
      <th>Std. Err.</th>
      <th>z</th>
      <th>Pr(&gt;|z|)</th>
      <th>Conf. Int. Low</th>
      <th>Cont. Int. Hi.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>work</th>
      <td>0.47034</td>
      <td>0.121697</td>
      <td>3.864838</td>
      <td>0.000111</td>
      <td>0.231818</td>
      <td>0.708862</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT. using the `marginaleffects` package</span>
<span class="n">me</span><span class="o">.</span><span class="n">slopes</span><span class="p">(</span><span class="n">lr1</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>term</th>
      <th>contrast</th>
      <th>estimate</th>
      <th>std_error</th>
      <th>statistic</th>
      <th>p_value</th>
      <th>s_value</th>
      <th>conf_low</th>
      <th>conf_high</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>work</td>
      <td>dY/dX</td>
      <td>0.47034</td>
      <td>0.12169</td>
      <td>3.865061</td>
      <td>0.000111</td>
      <td>13.136352</td>
      <td>0.231832</td>
      <td>0.708849</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ALT2. manual computation</span>
<span class="n">meanwork</span> <span class="o">=</span> <span class="n">interns</span><span class="p">[</span><span class="s2">&quot;work&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">p_at_mean</span> <span class="o">=</span> <span class="n">lr1</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s2">&quot;work&quot;</span><span class="p">:</span><span class="n">meanwork</span><span class="p">})</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">MEM</span> <span class="o">=</span> <span class="n">p_at_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p_at_mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">lr1</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;work&#39;</span><span class="p">]</span>
<span class="n">MEM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4703401778095685
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">marginaleffects</span></code> package provides some useful plots to visualize the predictions and slopes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># me.plot_predictions(lr1, condition=&quot;work&quot;)</span>
<span class="c1"># me.plot_slopes(lr1, condition=&quot;work&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p>Links to learn more about marginal effects</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=ANDC_kkAjeM">https://www.youtube.com/watch?v=ANDC_kkAjeM</a></p></li>
<li><p><a class="reference external" href="https://marginaleffects.com/">https://marginaleffects.com/</a></p></li>
<li><p><a class="reference external" href="https://www.statsmodels.org/dev/generated/statsmodels.discrete.discrete_model.LogitResults.get_margeff.html">https://www.statsmodels.org/dev/generated/statsmodels.discrete.discrete_model.LogitResults.get_margeff.html</a></p></li>
<li><p><a class="reference external" href="https://lost-stats.github.io/Model_Estimation/Statistical_Inference/Marginal_Effects_in_Nonlinear_Regression.html">https://lost-stats.github.io/Model_Estimation/Statistical_Inference/Marginal_Effects_in_Nonlinear_Regression.html</a></p></li>
<li><p><a class="reference external" href="https://clas.ucdenver.edu/marcelo-perraillon/sites/default/files/attached-files/perraillon_marginal_effects_lecture_lisbon.pdf">https://clas.ucdenver.edu/marcelo-perraillon/sites/default/files/attached-files/perraillon_marginal_effects_lecture_lisbon.pdf</a></p></li>
</ul>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "minireference/noBSstats",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#strategies-for-fitting-linear-models">Strategies for fitting linear models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-regression-plots">Partial regression plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sheffe-bands-several-different-ways">Sheffé bands (several different ways)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-predictive-accuracy">Model predictive accuracy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l1-regularization">L1 regularization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-correlation-matrix">Check the correlation matrix</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-model-fit-metrics">Other model fit metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-residual-plot">Partial residual plot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predictions-skipping-because-covered-in-sec-4-1">Predictions (skipping because covered in Sec 4.1)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#players-dataset">Players dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-linear-model-for-time-1-age">Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-linear-model-for-time-1-age-jobstatus">Plot of linear model for <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">~</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">age</span> <span class="pre">+</span> <span class="pre">jobstatus</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-select-subset-with-jobstatus-1">Manual select subset with jobstatus 1</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-confoudouder-2">Example confoudouder  2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-slopes-and-random-intercepts">Random slopes and random intercepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-n-campaign-responses">Example N: campaign responses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-comparison-cut-material">Model comparison (CUT MATERIAL)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lagrange-multiplier-test-optional">Lagrange multiplier test (optional)</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-calculations-of-leverage-metric">Manual calculations of leverage metric</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-projection-plots">Partial projection plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-regression-plot-for-the-predictor-alc">Partial regression plot for the predictor <code class="docutils literal notranslate"><span class="pre">alc</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#old">OLD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collider-bias-via-stratification">Collider bias via stratification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glm-bonus-topics">GLM bonus topics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scikitlearn-models">ScikitLearn models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standardization-of-predictors">Standardization of predictors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effects">Marginal effects</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-parameters">Raw parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effect-at-a-user-specified-value">Marginal effect at a user-specified value</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#average-marginal-effect-ame">Average marginal effect (AME)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#marginal-effect-at-the-mean-mem">Marginal effect at the mean (MEM)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ivan Savov
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>